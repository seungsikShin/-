# ìµœì í™”ëœ GPT ê°ì‚¬ë³´ê³ ì„œ ìƒì„± í•¨ìˆ˜
def generate_audit_report_with_gpt_optimized(submission_id, department, manager, phone, contract_name,
                                           contract_date, contract_amount, uploaded_files, missing_files_with_reasons) -> Optional[str]:
    try:
        # ì œì¶œ ìë£Œì˜ ì‹¤ì œ ë‚´ìš© ì¶”ì¶œ
        uploaded_content = ""
        if uploaded_files:
            uploaded_content = "## ì œì¶œëœ ìë£Œ ë° ë‚´ìš©\n\n"
            
            # DBì—ì„œ ì‹¤ì œ íŒŒì¼ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
            conn = sqlite3.connect('audit_system.db')
            c = conn.cursor()
            
            for file_name in uploaded_files:
                c.execute("SELECT file_path FROM uploaded_files WHERE submission_id = ? AND file_name = ?", 
                         (submission_id, file_name))
                result = c.fetchone()
                
                if result and os.path.exists(result[0]):
                    file_content = extract_file_content(result[0])
                    uploaded_content += f"### ğŸ“„ {file_name}\n"
                    uploaded_content += f"```\n{file_content[:2000]}\n```\n\n"  # ë‚´ìš© ê¸¸ì´ ì œí•œ
                else:
                    uploaded_content += f"### ğŸ“„ {file_name}\n[íŒŒì¼ ë‚´ìš© ì½ê¸° ì‹¤íŒ¨]\n\n"
            
            conn.close()
        else:
            uploaded_content = "ì œì¶œëœ ìë£Œ: ì—†ìŒ\n\n"
        
        # ëˆ„ë½ ìë£Œ ì •ë¦¬
        missing_content = ""
        if missing_files_with_reasons:
            missing_content = "## ëˆ„ë½ëœ ìë£Œ ë° ì‚¬ìœ \n\n"
            missing_content += "\n".join([f"- **{name}**: {reason}" for name, reason in missing_files_with_reasons])
        else:
            missing_content = "ëˆ„ë½ëœ ìë£Œ: ì—†ìŒ\n\n"
        
        # ğŸ”¥ ë‹¨ìˆœí™”ëœ í”„ë¡¬í”„íŠ¸ (System instructionsì— ì˜ì¡´)
        user_message = f"""
ì¼ìƒê°ì‚¬ ë³´ê³ ì„œ ì´ˆì•ˆì„ ì‘ì„±í•´ì£¼ì„¸ìš”.

## ê¸°ë³¸ ì •ë³´
**ì ‘ìˆ˜ ID**: {submission_id}
**ì ‘ìˆ˜ ë¶€ì„œ**: {department}  
**ë‹´ë‹¹ì**: {manager} (ì—°ë½ì²˜: {phone})
**ê³„ì•½ëª…**: {contract_name}
**ê³„ì•½ ì²´ê²°ì¼**: {contract_date}
**ê³„ì•½ê¸ˆì•¡**: {contract_amount}

{uploaded_content}

{missing_content}

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¼ìƒê°ì‚¬ ë³´ê³ ì„œ ì´ˆì•ˆì„ ì‘ì„±í•´ì£¼ì„¸ìš”.
"""
        
        # GPT ì‘ë‹µ ë°›ê¸°
        answer, success = get_clean_answer_from_gpts(user_message)
        if not success:
            return None

        # ì¸ìš© ë§ˆí¬ ì œê±°
        answer = re.sub(r'\ã€\d+\:\d+\â€ source\ã€‘', '', answer)
        answer = re.sub(r'\*\*(.*?)\:\*\*', r'\1', answer)
        
        # Word ë¬¸ì„œ ìƒì„±
        document = Document()
        document.add_heading('ì¼ìƒê°ì‚¬ ë³´ê³ ì„œ ì´ˆì•ˆ', level=0)
        
        # ì ‘ìˆ˜ ì •ë³´ í…Œì´ë¸” ì¶”ê°€
        info_table = document.add_table(rows=6, cols=2)
        info_table.style = 'Table Grid'
        
        info_data = [
            ('ì ‘ìˆ˜ ID', submission_id),
            ('ì ‘ìˆ˜ ë¶€ì„œ', department),
            ('ë‹´ë‹¹ì', f"{manager} ({phone})"),
            ('ê³„ì•½ëª…', contract_name),
            ('ê³„ì•½ ì²´ê²°ì¼', contract_date),
            ('ê³„ì•½ê¸ˆì•¡', contract_amount)
        ]
        
        for i, (label, value) in enumerate(info_data):
            info_table.cell(i, 0).text = label
            info_table.cell(i, 1).text = str(value)
        
        document.add_paragraph()  # ê³µë°± ì¶”ê°€
        
        # GPT ì‘ë‹µì„ ë¬¸ì„œì— ì¶”ê°€
        for line in answer.strip().split("\n"):
            line = line.strip()
            if not line:
                continue
                
            if line.startswith("â–  ") or line.startswith("# "):
                # ì£¼ìš” ì„¹ì…˜ í—¤ë”©
                heading_text = line.replace("â–  ", "").replace("# ", "")
                document.add_heading(heading_text, level=1)
            elif line.startswith("### "):
                document.add_heading(line.replace("### ", ""), level=3)
            elif line.startswith("## "):
                document.add_heading(line.replace("## ", ""), level=2)
            elif line.startswith("â†’ ") or line.startswith("- "):
                # ê¶Œê³ ì‚¬í•­ì´ë‚˜ ë¦¬ìŠ¤íŠ¸
                p = document.add_paragraph()
                p.style = 'List Bullet'
                p.add_run(line[2:])
            else:
                # ì¼ë°˜ ë¬¸ë‹¨
                document.add_paragraph(line)

        # ë³´ê³ ì„œ ì €ì¥
        report_folder = os.path.join(base_folder, "draft_reports")
        os.makedirs(report_folder, exist_ok=True)
        report_path = os.path.join(report_folder, f"ê°ì‚¬ë³´ê³ ì„œì´ˆì•ˆ_{submission_id}.docx")
        document.save(report_path)
        
        logger.info(f"ê°ì‚¬ë³´ê³ ì„œ ì´ˆì•ˆ ìƒì„± ì™„ë£Œ: {report_path}")
        return report_path

    except Exception as e:
        logger.error(f"GPT ë³´ê³ ì„œ ìƒì„± ì˜¤ë¥˜: {str(e)}")
        return None
