# íŒŒì¼ ë‚´ìš© ì½ê¸° í•¨ìˆ˜ ì¶”ê°€
def extract_file_content(file_path: str) -> str:
    """
    ì—…ë¡œë“œëœ íŒŒì¼ì˜ ë‚´ìš©ì„ ì¶”ì¶œí•˜ì—¬ í…ìŠ¤íŠ¸ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
    """
    try:
        file_ext = os.path.splitext(file_path)[1].lower()
        
        if file_ext == '.txt':
            with open(file_path, 'r', encoding='utf-8') as f:
                return f.read()
        
        elif file_ext == '.docx':
            doc = Document(file_path)
            content = []
            for paragraph in doc.paragraphs:
                content.append(paragraph.text)
            return '\n'.join(content)
        
        elif file_ext == '.pdf':
            try:
                import PyPDF2
                with open(file_path, 'rb') as f:
                    reader = PyPDF2.PdfReader(f)
                    content = []
                    for page in reader.pages:
                        content.append(page.extract_text())
                    return '\n'.join(content)
            except ImportError:
                return "[PDF íŒŒì¼ - ë‚´ìš© ì½ê¸° ë¶ˆê°€: PyPDF2 ëª¨ë“ˆ í•„ìš”]"
        
        elif file_ext in ['.jpg', '.jpeg', '.png', '.gif']:
            return "[ì´ë¯¸ì§€ íŒŒì¼ - í…ìŠ¤íŠ¸ ë‚´ìš© ì—†ìŒ]"
        
        elif file_ext in ['.xlsx', '.xls']:
            try:
                import pandas as pd
                df = pd.read_excel(file_path)
                return df.to_string()
            except ImportError:
                return "[ì—‘ì…€ íŒŒì¼ - ë‚´ìš© ì½ê¸° ë¶ˆê°€: pandas ëª¨ë“ˆ í•„ìš”]"
        
        else:
            # ê¸°íƒ€ í…ìŠ¤íŠ¸ íŒŒì¼ ì‹œë„
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    return f.read()
            except UnicodeDecodeError:
                try:
                    with open(file_path, 'r', encoding='cp949') as f:
                        return f.read()
                except:
                    return "[íŒŒì¼ ë‚´ìš© ì½ê¸° ì‹¤íŒ¨]"
    
    except Exception as e:
        logger.error(f"íŒŒì¼ ë‚´ìš© ì¶”ì¶œ ì˜¤ë¥˜: {str(e)}")
        return f"[íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: {str(e)}]"

# ê°œì„ ëœ GPT ê°ì‚¬ë³´ê³ ì„œ ìƒì„± í•¨ìˆ˜
def generate_audit_report_with_gpt_enhanced(submission_id, department, manager, phone, contract_name,
                                           contract_date, contract_amount, uploaded_files, missing_files_with_reasons) -> Optional[str]:
    try:
        # ì œì¶œ ìë£Œì˜ ì‹¤ì œ ë‚´ìš© ì¶”ì¶œ
        uploaded_content = ""
        if uploaded_files:
            uploaded_content = "## ì œì¶œëœ ìë£Œ ë° ë‚´ìš©\n\n"
            
            # DBì—ì„œ ì‹¤ì œ íŒŒì¼ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
            conn = sqlite3.connect('audit_system.db')
            c = conn.cursor()
            
            for file_name in uploaded_files:
                c.execute("SELECT file_path FROM uploaded_files WHERE submission_id = ? AND file_name = ?", 
                         (submission_id, file_name))
                result = c.fetchone()
                
                if result and os.path.exists(result[0]):
                    file_content = extract_file_content(result[0])
                    uploaded_content += f"### ğŸ“„ {file_name}\n"
                    uploaded_content += f"```\n{file_content[:2000]}\n```\n\n"  # ë‚´ìš© ê¸¸ì´ ì œí•œ
                else:
                    uploaded_content += f"### ğŸ“„ {file_name}\n[íŒŒì¼ ë‚´ìš© ì½ê¸° ì‹¤íŒ¨]\n\n"
            
            conn.close()
        else:
            uploaded_content = "## ì œì¶œëœ ìë£Œ\nì—†ìŒ\n\n"
        
        # ëˆ„ë½ ìë£Œ ì •ë¦¬
        missing_list = ""
        if missing_files_with_reasons:
            missing_list = "## ëˆ„ë½ëœ ìë£Œ ë° ì‚¬ìœ \n\n"
            missing_list += "\n".join([f"- **{name}**: {reason}" for name, reason in missing_files_with_reasons])
        else:
            missing_list = "## ëˆ„ë½ëœ ìë£Œ\nì—†ìŒ\n\n"
        
        # ê°œì„ ëœ í”„ë¡¬í”„íŠ¸ (ì‹¤ì œ íŒŒì¼ ë‚´ìš© í¬í•¨)
        user_message = f"""
ë‹¤ìŒ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ, ìƒì„¸í•˜ê³  ì „ë¬¸ì ì¸ ì¼ìƒê°ì‚¬ ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”:

## ê³„ì•½ ê¸°ë³¸ ì •ë³´
- ì ‘ìˆ˜ ID: {submission_id}
- ì ‘ìˆ˜ ë¶€ì„œ: {department}
- ë‹´ë‹¹ì: {manager} (ì—°ë½ì²˜: {phone})
- ê³„ì•½ëª…: {contract_name}
- ê³„ì•½ ì²´ê²°ì¼: {contract_date}
- ê³„ì•½ê¸ˆì•¡: {contract_amount}

{uploaded_content}

{missing_list}

## ë³´ê³ ì„œ ì‘ì„± ì§€ì¹¨
1. ì œì¶œëœ íŒŒì¼ì˜ ì‹¤ì œ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ êµ¬ì²´ì ì¸ ê²€í†  ì˜ê²¬ì„ ì œì‹œí•  ê²ƒ
2. ê³„ì•½ì„œ, í’ˆì˜ì„œ, ì…ì°°í‰ê°€í‘œ ë“±ì˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì ì •ì„±ì„ í‰ê°€í•  ê²ƒ
3. ëˆ„ë½ëœ ìë£Œë¡œ ì¸í•œ ì œì•½ì‚¬í•­ì„ ëª…ì‹œí•  ê²ƒ
4. ê° í•­ëª©ë³„ë¡œ "í˜„í™© â†’ ê²€í† ì˜ê²¬ â†’ ê°œì„ ì‚¬í•­" êµ¬ì¡°ë¡œ ì„œìˆ í•  ê²ƒ
5. êµ¬ì²´ì ì¸ ìˆ˜ì¹˜ë‚˜ ì¡°ê±´ì´ ìˆë‹¤ë©´ ì´ë¥¼ ì¸ìš©í•˜ì—¬ ë¶„ì„í•  ê²ƒ
6. ì „ë¬¸ì ì¸ ê°ì‚¬ ê´€ì ì—ì„œ ìœ„í—˜ìš”ì†Œë‚˜ ê°œì„ ì ì„ ë„ì¶œí•  ê²ƒ

ì‹¤ì œ ì œì¶œ ìë£Œì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ì „ë¬¸ì ì´ê³  ì‹¤ì§ˆì ì¸ ê°ì‚¬ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.
"""
        
        # GPT ì‘ë‹µ ë°›ê¸°
        answer, success = get_clean_answer_from_gpts(user_message)
        if not success:
            return None

        # ì¸ìš© ë§ˆí¬ ë° ë³¼ë“œ ì½œë¡  íŒ¨í„´ ì œê±°
        answer = re.sub(r'\ã€\d+\:\d+\â€ source\ã€‘', '', answer)
        answer = re.sub(r'\*\*(.*?)\:\*\*', r'\1', answer)
        
        # Word ë¬¸ì„œ ìƒì„±
        document = Document()
        document.add_heading('ì¼ìƒê°ì‚¬ ë³´ê³ ì„œ ì´ˆì•ˆ', level=0)
        
        # ë³´ê³ ì„œ ë‚´ìš©ì„ ì ì ˆí•œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        for line in answer.strip().split("\n"):
            if line.strip().startswith("# "):
                document.add_heading(line.replace("# ", "").strip(), level=1)
            elif line.strip().startswith("## "):
                document.add_heading(line.replace("## ", "").strip(), level=2)
            elif line.strip().startswith("### "):
                document.add_heading(line.replace("### ", "").strip(), level=3)
            elif line.strip().startswith("- ") or line.strip().startswith("* "):
                p = document.add_paragraph()
                p.style = 'List Bullet'
                p.add_run(line.strip()[2:])
            else:
                if line.strip():
                    document.add_paragraph(line.strip())

        report_folder = os.path.join(base_folder, "draft_reports")
        os.makedirs(report_folder, exist_ok=True)
        report_path = os.path.join(report_folder, f"ê°ì‚¬ë³´ê³ ì„œì´ˆì•ˆ_{submission_id}.docx")
        document.save(report_path)
        return report_path

    except Exception as e:
        logger.error(f"GPT ë³´ê³ ì„œ ìƒì„± ì˜¤ë¥˜: {str(e)}")
        return None
